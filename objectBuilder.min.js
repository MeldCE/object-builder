// Object Builder 0.5 (https://github.com/weldstudio/object-builder)
// Copyright The Weld Studio 2012 (http://www.theweldstudio.com)
// This work is licenced under a Creative Commons License http://creativecommons.org/licenses/by-nc-sa/3.0/
function ObjectBuilder(a,b,c,d,e){this.div=a,this.input=b,e&&(this.full=!0),a&&(this._create(),c&&(d||(d=!1),this.rebuild(c,d)))}ObjectBuilder.prototype={_create:function(){div.appendChild(this.pad=document.createElement("div")),this.pad.setAttribute("data-value","pad"),this.pad.className="pad",this.pad.innerHTML="",this.store=document.createElement("div"),this.store.className="store",this.full||(this.store.style.display="none",document.body.addEventListener("click",this)),div.appendChild(this.store)},rebuild:function(a){try{this.pad.innerHTML="",this.store.innerHTML="";var b;for(b in a){var c=!1;a[b].className&&(c=a[b].className),a[b].label&&(this.store.appendChild(title=document.createElement("div")),title.innerHTML=a[b].label,title.className="title");if(a[b].elements){var d=a[b].elements;this.store.appendChild(eStore=document.createElement("div")),eStore.className="elementStore";var e;for(e in d){var f;eStore.appendChild(f=this._createItem(c)),f.setAttribute("data-type",b),d[e].label&&(f.appendChild(label=document.createElement("div")),label.className="label",label.innerHTML=d[e].label),d[e].value&&f.setAttribute("data-value",d[e].value),d[e].editable&&f.setAttribute("data-editable",1);if(d[e].objects){f.setAttribute("data-has-objects",1),f.appendChild(label=document.createElement("div")),label.className="label",label.innerHTML="(";var g=!0,h=d[e].objects,i;for(o in h)g||(f.appendChild(label=document.createElement("div")),label.className="label",label.innerHTML=", "),f.appendChild(i=this._createItem("object")),i.innerHTML="",i.setAttribute("data-has-objects",1),h[o].many&&i.setAttribute("data-many",1),g=!1;f.appendChild(label=document.createElement("div")),label.className="label",label.innerHTML=")"}}}}this.current=[]}catch(b){}},_createItem:function(a){var b=document.createElement("div");return b.setAttribute("data-builder",1),b.className="element",a&&(b.className+=" "+a),b.addEventListener("mousedown",this,!0),b},changeValue:function(a){var b=prompt("Please choose a value",a.getAttribute("data-value"));a.setAttribute("data-value",b),a.innerHTML='<div class="label">'+b+"</div>"},deleteItem:function(a){a.parentNode.removeChild(a)},_parse:function(){return this._parseRecurse(this.pad)},_parseRecurse:function(a){var b=a.childNodes,c,d=[];for(c=0;c<b.length;c++)if(b[c].hasAttribute("data-builder")){var e={};b[c].hasAttribute("data-type")?(e.type=b[c].getAttribute("data-type"),b[c].hasAttribute("data-value")&&(e.value=b[c].getAttribute("data-value")),b[c].hasAttribute("data-has-objects")&&(e.children=this._parseRecurse(b[c]))):b[c].hasAttribute("data-has-objects")&&(e=this._parseRecurse(b[c])),d.push(e)}return d},_findProposal:function(){if(!this.drag||!Mouse.isOver(this.pad))return!1;var a=this._findPropRecurse(this.pad);return a?a:!1},_findPropRecurse:function(a){var b=!a.hasAttribute("data-many"),c=a.childNodes,d,e=!1,f=!1,g=0;for(d=0;d<c.length;d++){if(this.proposed&&c[d]==this.proposed){f=!0;continue}if(c[d].hasAttribute("data-builder")){if(c[d].hasAttribute("data-has-objects"))if(Mouse.isInXRange(c[d])){var h=this._findPropRecurse(c[d]);if(h)return h;g=$(c[d]).offset().left+c[d].clientWidth/2}else g=$(c[d]).offset().left;else g=$(c[d]).offset().left+c[d].clientWidth/2;if(b)return!1;if(Mouse.before(g,null)){if(f)return!0;e=c[d];break}}f=!1}return a.hasAttribute("data-function")?!1:f?!0:{proposed:a,before:e}},alertObject:function(){alert(serialize(this._parse()))},handleEvent:function(a){a.type=="click"&&a.button==0&&(this.store.style.display=="none"?Mouse.isOver(this.pad)&&(this.store.style.display=""):!Mouse.isOver(this.pad)&&!Mouse.isOver(this.store)&&(this.store.style.display="none")),a.type=="mousedown"&&a.button==0&&(a.preventDefault(),a.stopPropagation(),inArray(a.currentTarget,this.current)&&(this.proposed=a.currentTarget,this.proposed.style.opacity="0.6"),this.drag=a.currentTarget.cloneNode(!0),this.drag.style.position="absolute",this.drag.style.zIndex=200,this.drag.style.opacity=.6,document.body.addEventListener("mousemove",this,!0),document.body.addEventListener("mouseup",this,!0),this.offset=$(a.currentTarget).offset(),document.body.appendChild(this.drag),this.drag.style.top=Math.round(this.offset.top)+"px",this.drag.style.left=Math.round(this.offset.left)+"px",this.offset.left=a.clientX+document.body.scrollLeft-this.offset.left,this.offset.top=a.clientY+document.body.scrollTop-this.offset.top);if(this.drag)if(a.type=="mousemove"){var b=Math.round(a.clientX+document.body.scrollLeft-this.offset.left),c=Math.round(a.clientY+document.body.scrollTop-this.offset.top);this.drag.style.top=c+"px",this.drag.style.left=b+"px";var d=this._findProposal();d?(this.proposed&&this.proposeRemove&&(this.proposed.style.display="",this.drag.style.backgroundColor="",this.proposed.style.backgroundColor="",this.proposeRemove=!1),d!==!0&&(this.proposed?this.proposed.parentNode.removeChild(this.proposed):(this.proposed=this.drag.cloneNode(!0),this.proposed.style.position="relative",this.proposed.style.top=0,this.proposed.style.left=0,this.proposed.style.zindex="auto"),d.before?d.proposed.insertBefore(this.proposed,d.before):d.proposed.appendChild(this.proposed))):(Mouse.isOver(this.pad)?(this.drag.style.backgroundColor="#fcc",this.proposeRemove=!0):this.drag.style.backgroundColor="",this.proposed&&(this.proposed.style.display="none",this.proposeRemove=!0,this.drag.style.backgroundColor="#fcc"))}else if(a.type=="mouseup"&&a.button==0){if(this.proposed){if(this.proposed.style.display=="none")this.proposed.parentNode.removeChild(this.proposed),inArray(a.currentTarget,this.current)&&deleteElement(this.current,a.currentTarget);else{this.proposed.style.opacity="";var e=this;inArray(a.currentTarget,this.current)||this.current.push(this.proposed),this.proposed.hasAttribute("data-editable")&&(this.proposed.onclick=function(a){e.changeValue(this),a.preventDefault(),a.stopPropagation()}),this.proposed.ondblclick=function(a){e.deleteItem(this),a.preventDefault(),a.stopPropagation()}}delete this.proposed}this.proposeRemove&&delete this.proposeRemove,document.body.removeChild(this.drag),delete this.drag,document.body.removeEventListener("mousemove",this,!0),document.body.removeEventListener("mouseup",this,!0),this.input&&(this.input.value=serialize(this._parse()))}return!1}}
